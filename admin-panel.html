<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - MegaPersonals Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a0a2e 0%, #2d1f3d 50%, #1a0a2e 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(90deg, #ff69b4, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: none;
        }
        
        /* Tarjetas de resumen financiero */
        .finance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .finance-card {
            background: linear-gradient(145deg, rgba(45,31,61,0.9), rgba(26,10,31,0.9));
            border: 1px solid rgba(255,105,180,0.3);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .finance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }
        
        .finance-card.income::before {
            background: linear-gradient(90deg, #00ff88, #00cc6a);
        }
        
        .finance-card.expense::before {
            background: linear-gradient(90deg, #ff6b6b, #ee5a52);
        }
        
        .finance-card.balance::before {
            background: linear-gradient(90deg, #ff69b4, #9333ea);
        }
        
        .finance-card.accounts::before {
            background: linear-gradient(90deg, #00d4ff, #0099cc);
        }
        
        .finance-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .finance-label {
            color: #999;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        
        .finance-value {
            font-size: 1.8em;
            font-weight: 700;
        }
        
        .finance-value.positive {
            color: #00ff88;
        }
        
        .finance-value.negative {
            color: #ff6b6b;
        }
        
        .finance-value.neutral {
            color: #ff69b4;
        }
        
        .card {
            background: linear-gradient(145deg, rgba(45,31,61,0.9), rgba(26,10,31,0.9));
            border: 1px solid rgba(255,105,180,0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
        }
        
        .card h2 {
            color: #ff69b4;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,105,180,0.3);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,105,180,0.3);
            font-size: 14px;
            transition: all 0.3s;
            background: rgba(0,0,0,0.3);
            color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ff69b4;
            box-shadow: 0 0 10px rgba(255,105,180,0.3);
        }
        
        input::placeholder {
            color: #666;
        }
        
        button {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff69b4, #9333ea);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255,105,180,0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #003d20;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffa500, #ff8c00);
            color: #4d3200;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        /* Tablas */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th {
            background: rgba(255,105,180,0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #ff69b4;
            border-bottom: 1px solid rgba(255,105,180,0.3);
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        tr:hover {
            background: rgba(255,105,180,0.05);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .status-active {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
        }
        
        .status-blocked {
            background: rgba(255,107,107,0.2);
            color: #ff6b6b;
        }
        
        .status-available {
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
        }
        
        .status-expired {
            background: rgba(150,150,150,0.2);
            color: #999;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,105,180,0.3);
            border-radius: 10px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            background: rgba(255,105,180,0.2);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #ff69b4, #9333ea);
            color: white;
            border-color: transparent;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #2d1f3d, #1a0a2e);
            border: 1px solid rgba(255,105,180,0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #ff69b4;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #999;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        .link-display {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        .link-input {
            flex: 1;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,105,180,0.3);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #00ff88;
        }
        
        .success-message {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: rgba(0,212,255,0.1);
            border-color: #00d4ff;
        }
        
        /* Historial de pagos */
        .payment-history {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .payment-item .date {
            color: #999;
        }
        
        .payment-item .amount {
            color: #00ff88;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .finance-summary {
                grid-template-columns: 1fr 1fr;
            }
            
            .tabs {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Panel de Administraci√≥n</h1>
        
        <!-- Resumen Financiero -->
        <div class="finance-summary">
            <div class="finance-card income">
                <div class="finance-icon">üí∞</div>
                <div class="finance-label">Total Cobrado</div>
                <div class="finance-value positive" id="totalIncome">$0</div>
            </div>
            <div class="finance-card expense">
                <div class="finance-icon">üí∏</div>
                <div class="finance-label">Total Gastado</div>
                <div class="finance-value negative" id="totalExpense">$0</div>
            </div>
            <div class="finance-card balance">
                <div class="finance-icon">üìä</div>
                <div class="finance-label">Balance</div>
                <div class="finance-value neutral" id="totalBalance">$0</div>
            </div>
            <div class="finance-card accounts">
                <div class="finance-icon">üì±</div>
                <div class="finance-label">Cuentas MP</div>
                <div class="finance-value" id="accountsCount" style="color: #00d4ff;">0</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('clients')">üë• Clientes (<span id="clientCount">0</span>)</button>
            <button class="tab-btn" onclick="showTab('accounts')">üì± Cuentas MegaPersonals</button>
            <button class="tab-btn" onclick="showTab('finances')">üíµ Movimientos</button>
        </div>
        
        <!-- Tab: Clientes -->
        <div id="tab-clients" class="tab-content active">
            <div class="card">
                <h2>‚ûï Agregar Nuevo Cliente</h2>
                <form id="addClientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre del Cliente *</label>
                            <input type="text" id="clientName" placeholder="Ej: Juan P√©rez" required>
                        </div>
                        <div class="form-group">
                            <label>Cuenta MegaPersonals *</label>
                            <select id="mpAccount" required>
                                <option value="">Seleccionar cuenta...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duraci√≥n (d√≠as)</label>
                            <input type="number" id="duration" value="7" min="1" max="365">
                        </div>
                        <div class="form-group">
                            <label>Fecha/Hora Inicio</label>
                            <input type="datetime-local" id="startTime">
                        </div>
                        <div class="form-group">
                            <label>üíµ Pago del Cliente ($)</label>
                            <input type="number" id="clientPayment" placeholder="100" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="text" id="clientPhone" placeholder="Ej: 123-456-7890">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Notas</label>
                        <textarea id="notes" rows="2" placeholder="Notas adicionales..."></textarea>
                    </div>
                    <button type="submit" class="btn-primary">‚ûï Agregar Cliente</button>
                </form>
                
                <div id="linkDisplay" class="link-display" style="display: none;">
                    <input type="text" id="generatedLink" class="link-input" readonly>
                    <button onclick="copyLink()" class="btn-info btn-small">üìã Copiar</button>
                    <button onclick="openLink()" class="btn-success btn-small">üîó Abrir</button>
                </div>
                <div id="successMessage" class="success-message">‚úÖ Cliente agregado exitosamente!</div>
            </div>
            
            <div class="card">
                <h2>üë• Lista de Clientes</h2>
                <input type="text" id="searchInput" placeholder="üîç Buscar cliente..." onkeyup="filterClients()" style="width: 100%; margin-bottom: 15px;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Cuenta MP</th>
                                <th>Estado</th>
                                <th>Pagos</th>
                                <th>Restante</th>
                                <th>Finaliza</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px; color: #999;">
                                    No hay clientes registrados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tab: Cuentas MegaPersonals -->
        <div id="tab-accounts" class="tab-content">
            <div class="card">
                <h2>‚ûï Agregar Cuenta MegaPersonals</h2>
                <form id="addAccountForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre/Identificador *</label>
                            <input type="text" id="accountName" placeholder="Ej: MP-001, Cuenta Principal" required>
                        </div>
                        <div class="form-group">
                            <label>üí∏ Costo de la Cuenta ($) *</label>
                            <input type="number" id="accountCost" placeholder="280" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>üìß Email/Usuario *</label>
                            <input type="text" id="accountEmail" placeholder="email@ejemplo.com" required>
                        </div>
                        <div class="form-group">
                            <label>üîë Contrase√±a *</label>
                            <input type="text" id="accountPassword" placeholder="contrase√±a123" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Compra</label>
                            <input type="date" id="accountDate">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Notas</label>
                        <textarea id="accountNotes" rows="2" placeholder="Notas sobre la cuenta..."></textarea>
                    </div>
                    <button type="submit" class="btn-primary">‚ûï Agregar Cuenta</button>
                </form>
            </div>
            
            <div class="card">
                <h2>üì± Cuentas MegaPersonals Activas</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cuenta</th>
                                <th>Credenciales</th>
                                <th>Costo</th>
                                <th>Estado</th>
                                <th>Cliente Actual</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px; color: #999;">
                                    No hay cuentas registradas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card" style="border-color: rgba(255,107,107,0.3);">
                <h2 style="color: #ff6b6b;">üö´ Cuentas Bloqueadas</h2>
                <p style="color: #999; margin-bottom: 15px; font-size: 0.9em;">Cuentas que fueron bloqueadas y representan p√©rdidas</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cuenta</th>
                                <th>üìß Email</th>
                                <th>üîë Contrase√±a</th>
                                <th>üí∏ Costo (P√©rdida)</th>
                                <th>Fecha Bloqueo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="blockedAccountsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px; color: #999;">
                                    No hay cuentas bloqueadas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tab: Movimientos Financieros -->
        <div id="tab-finances" class="tab-content">
            <div class="card">
                <h2>üíµ Historial de Movimientos</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                            </tr>
                        </thead>
                        <tbody id="movementsTableBody">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 30px; color: #999;">
                                    No hay movimientos registrados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Renovaci√≥n -->
    <div id="renewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîÑ Renovar Cliente</h3>
                <button class="modal-close" onclick="closeRenewModal()">&times;</button>
            </div>
            <form id="renewForm">
                <input type="hidden" id="renewClientId">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Cliente</label>
                    <input type="text" id="renewClientName" readonly style="background: rgba(0,0,0,0.5);">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>D√≠as adicionales</label>
                    <input type="number" id="renewDays" value="7" min="1" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>üíµ Monto de Renovaci√≥n ($)</label>
                    <input type="number" id="renewAmount" placeholder="100" min="0" step="0.01" required>
                </div>
                <button type="submit" class="btn-success" style="width: 100%;">‚úÖ Confirmar Renovaci√≥n</button>
            </form>
        </div>
    </div>
    
    <script>
        const BUMP_INTERVAL = 15.25; // minutos
        const FIREBASE_URL = 'https://ezequielredd-default-rtdb.firebaseio.com';
        
        // Inicializar fecha actual
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('startTime').value = now.toISOString().slice(0, 16);
        document.getElementById('accountDate').value = now.toISOString().slice(0, 10);
        
        // ==================== TABS ====================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // ==================== CUENTAS MEGAPERSONALS ====================
        function getAccounts() {
            return JSON.parse(localStorage.getItem('mp_accounts') || '{}');
        }
        
        function saveAccounts(accounts) {
            localStorage.setItem('mp_accounts', JSON.stringify(accounts));
        }
        
        function getBlockedAccounts() {
            return JSON.parse(localStorage.getItem('mp_blocked_accounts') || '{}');
        }
        
        function saveBlockedAccounts(accounts) {
            localStorage.setItem('mp_blocked_accounts', JSON.stringify(accounts));
        }
        
        document.getElementById('addAccountForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const accountId = 'acc_' + Date.now();
            const account = {
                id: accountId,
                name: document.getElementById('accountName').value.trim(),
                cost: parseFloat(document.getElementById('accountCost').value) || 0,
                email: document.getElementById('accountEmail').value.trim(),
                password: document.getElementById('accountPassword').value.trim(),
                purchaseDate: document.getElementById('accountDate').value,
                notes: document.getElementById('accountNotes').value.trim(),
                status: 'available', // available, in_use
                currentClient: null,
                createdAt: Date.now()
            };
            
            const accounts = getAccounts();
            accounts[accountId] = account;
            saveAccounts(accounts);
            
            // Registrar gasto
            addMovement('expense', `Compra cuenta: ${account.name}`, account.cost);
            
            document.getElementById('addAccountForm').reset();
            document.getElementById('accountDate').value = now.toISOString().slice(0, 10);
            
            updateAll();
            alert('‚úÖ Cuenta agregada exitosamente!');
        });
        
        function updateAccountsTable() {
            const accounts = getAccounts();
            const accountsArray = Object.values(accounts);
            const tbody = document.getElementById('accountsTableBody');
            
            // Contar cuentas activas (no bloqueadas)
            document.getElementById('accountsCount').textContent = accountsArray.length;
            
            // Actualizar select de cuentas
            const select = document.getElementById('mpAccount');
            select.innerHTML = '<option value="">Seleccionar cuenta...</option>';
            accountsArray.filter(a => a.status === 'available').forEach(acc => {
                select.innerHTML += `<option value="${acc.id}">${acc.name} ($${acc.cost})</option>`;
            });
            
            if (accountsArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">No hay cuentas activas</td></tr>`;
            } else {
                tbody.innerHTML = accountsArray.map(acc => {
                    let statusClass, statusText;
                    if (acc.status === 'available') {
                        statusClass = 'status-available';
                        statusText = 'üîµ Disponible';
                    } else {
                        statusClass = 'status-active';
                        statusText = 'üü¢ En Uso';
                    }
                    
                    const clientName = acc.currentClient ? getClientName(acc.currentClient) : '-';
                    
                    return `
                        <tr>
                            <td><strong>${acc.name}</strong></td>
                            <td>
                                <small style="color:#999">üìß ${acc.email}</small><br>
                                <small style="color:#666">üîë ${acc.password}</small>
                            </td>
                            <td>$${acc.cost.toFixed(2)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${clientName}</td>
                            <td>
                                <button onclick="markAccountBlocked('${acc.id}')" class="btn-danger btn-small" title="Marcar como bloqueada">üö´ Bloqueada</button>
                                <button onclick="deleteAccount('${acc.id}')" class="btn-danger btn-small" title="Eliminar" style="margin-left:5px;">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Actualizar tabla de cuentas bloqueadas
            updateBlockedAccountsTable();
        }
        
        function updateBlockedAccountsTable() {
            const blockedAccounts = getBlockedAccounts();
            const blockedArray = Object.values(blockedAccounts);
            const tbody = document.getElementById('blockedAccountsTableBody');
            
            // Tambi√©n obtener cuentas bloqueadas reportadas por la extensi√≥n desde Firebase
            fetchBlockedFromFirebase().then(firebaseBlocked => {
                const allBlocked = [...blockedArray, ...firebaseBlocked];
                
                if (allBlocked.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">No hay cuentas bloqueadas</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = allBlocked.map(acc => {
                    const blockedDate = acc.blockedAt ? new Date(acc.blockedAt).toLocaleDateString('es-ES') : '-';
                    const cost = acc.cost || 0;
                    const source = acc.reportedFrom === 'extension' ? 'ü§ñ Auto' : 'üë§ Manual';
                    
                    return `
                        <tr style="background: rgba(255,107,107,0.05);">
                            <td>
                                <strong style="color:#ff6b6b">${acc.name || 'Cuenta'}</strong>
                                <br><small style="color:#666">${source}</small>
                            </td>
                            <td style="font-family: monospace; color: #ccc;">${acc.email || '-'}</td>
                            <td style="font-family: monospace; color: #ccc;">${acc.password || '-'}</td>
                            <td style="color:#ff6b6b; font-weight: bold;">-$${cost.toFixed(2)}</td>
                            <td>${blockedDate}</td>
                            <td>
                                <button onclick="recoverAccount('${acc.id}')" class="btn-success btn-small" title="Recuperar cuenta">‚úÖ Recuperar</button>
                                <button onclick="deleteBlockedAccount('${acc.id}')" class="btn-danger btn-small" title="Eliminar registro" style="margin-left:5px;">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            });
        }
        
        // Obtener cuentas bloqueadas desde Firebase (reportadas por la extensi√≥n)
        async function fetchBlockedFromFirebase() {
            try {
                const response = await fetch(`${FIREBASE_URL}/blockedAccounts.json`);
                const data = await response.json();
                
                if (!data) return [];
                
                return Object.entries(data).map(([id, acc]) => ({
                    id: id,
                    name: acc.email ? acc.email.split('@')[0] : 'Cuenta',
                    email: acc.email,
                    password: acc.password,
                    cost: 0, // No sabemos el costo, se puede editar manualmente
                    blockedAt: acc.blockedAt,
                    reportedFrom: acc.reportedFrom || 'extension',
                    clientId: acc.clientId
                }));
            } catch (error) {
                console.error('Error fetching blocked accounts from Firebase:', error);
                return [];
            }
        }
        
        function getClientName(clientId) {
            const clients = getClients();
            return clients[clientId]?.name || 'Desconocido';
        }
        
        function markAccountBlocked(accountId) {
            if (!confirm('‚ö†Ô∏è ¬øMarcar esta cuenta como BLOQUEADA?\n\nEsto:\n‚Ä¢ Mover√° la cuenta a "Cuentas Bloqueadas"\n‚Ä¢ Registrar√° la p√©rdida\n‚Ä¢ Liberar√° al cliente si tiene uno asignado')) return;
            
            const accounts = getAccounts();
            const account = accounts[accountId];
            
            if (account) {
                // Liberar cliente si tiene uno
                if (account.currentClient) {
                    const clients = getClients();
                    if (clients[account.currentClient]) {
                        clients[account.currentClient].accountId = null;
                        saveClients(clients);
                    }
                }
                
                // Mover a bloqueadas
                const blockedAccounts = getBlockedAccounts();
                account.blockedAt = Date.now();
                account.status = 'blocked';
                blockedAccounts[accountId] = account;
                saveBlockedAccounts(blockedAccounts);
                
                // Eliminar de activas
                delete accounts[accountId];
                saveAccounts(accounts);
                
                // Registrar p√©rdida
                addMovement('loss', `Cuenta bloqueada: ${account.name} (${account.email})`, account.cost);
                
                updateAll();
                alert('üö´ Cuenta marcada como bloqueada y movida al historial');
            }
        }
        
        function recoverAccount(accountId) {
            if (!confirm('‚úÖ ¬øRecuperar esta cuenta?\n\nEsto:\n‚Ä¢ Mover√° la cuenta de vuelta a activas\n‚Ä¢ Revertir√° la p√©rdida registrada')) return;
            
            const blockedAccounts = getBlockedAccounts();
            const account = blockedAccounts[accountId];
            
            if (account) {
                // Mover a activas
                const accounts = getAccounts();
                account.status = 'available';
                account.currentClient = null;
                delete account.blockedAt;
                accounts[accountId] = account;
                saveAccounts(accounts);
                
                // Eliminar de bloqueadas
                delete blockedAccounts[accountId];
                saveBlockedAccounts(blockedAccounts);
                
                // Revertir p√©rdida
                addMovement('recovery', `Cuenta recuperada: ${account.name} (${account.email})`, account.cost);
                
                updateAll();
                alert('‚úÖ Cuenta recuperada y disponible nuevamente');
            }
        }
        
        function deleteAccount(accountId) {
            if (!confirm('¬øEliminar esta cuenta permanentemente?\n\nNota: Si quieres registrar que fue bloqueada, usa el bot√≥n "üö´ Bloqueada" en su lugar.')) return;
            
            const accounts = getAccounts();
            delete accounts[accountId];
            saveAccounts(accounts);
            updateAll();
        }
        
        function deleteBlockedAccount(accountId) {
            if (!confirm('¬øEliminar este registro de cuenta bloqueada?\n\nNota: Esto solo elimina el registro, no afecta las finanzas.')) return;
            
            const blockedAccounts = getBlockedAccounts();
            delete blockedAccounts[accountId];
            saveBlockedAccounts(blockedAccounts);
            updateAll();
        }
        
        // ==================== CLIENTES ====================
        function getClients() {
            // Intentar leer del nuevo formato primero
            let clients = JSON.parse(localStorage.getItem('mp_clients') || '{}');
            
            // Si est√° vac√≠o, intentar migrar del formato anterior
            if (Object.keys(clients).length === 0) {
                const oldClients = JSON.parse(localStorage.getItem('megapersonals_clients') || '{}');
                if (Object.keys(oldClients).length > 0) {
                    console.log('üì¶ Migrando clientes del formato anterior...');
                    // Migrar al nuevo formato
                    for (const [id, client] of Object.entries(oldClients)) {
                        clients[id] = {
                            ...client,
                            payments: [{
                                date: client.createdAt || Date.now(),
                                amount: 0,
                                type: 'initial',
                                note: 'Migrado del sistema anterior'
                            }],
                            totalPaid: 0,
                            accountId: null
                        };
                    }
                    saveClients(clients);
                    console.log('‚úÖ Migraci√≥n completada:', Object.keys(clients).length, 'clientes');
                }
            }
            
            return clients;
        }
        
        function saveClients(clients) {
            localStorage.setItem('mp_clients', JSON.stringify(clients));
        }
        
        document.getElementById('addClientForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const accountId = document.getElementById('mpAccount').value || null;
            
            const clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const payment = parseFloat(document.getElementById('clientPayment').value) || 0;
            const duration = parseInt(document.getElementById('duration').value);
            const startTime = new Date(document.getElementById('startTime').value).getTime();
            
            const client = {
                id: clientId,
                name: document.getElementById('clientName').value.trim(),
                phone: document.getElementById('clientPhone').value.trim(),
                accountId: accountId,
                duration: duration * 24 * 60, // minutos
                startTime: startTime,
                active: true,
                lastBumpTime: startTime,
                nextBumpTime: startTime + (BUMP_INTERVAL * 60 * 1000),
                notes: document.getElementById('notes').value.trim(),
                payments: [{
                    date: Date.now(),
                    amount: payment,
                    type: 'initial',
                    note: 'Pago inicial'
                }],
                totalPaid: payment,
                createdAt: Date.now()
            };
            
            // Actualizar cuenta MP si se seleccion√≥ una
            if (accountId) {
                const accounts = getAccounts();
                if (accounts[accountId]) {
                    accounts[accountId].status = 'in_use';
                    accounts[accountId].currentClient = clientId;
                    saveAccounts(accounts);
                }
            }
            
            // Guardar cliente
            const clients = getClients();
            clients[clientId] = client;
            saveClients(clients);
            
            // Registrar ingreso si hay pago
            if (payment > 0) {
                addMovement('income', `Pago inicial: ${client.name}`, payment);
            }
            
            // Generar link
            const baseUrl = window.location.href.replace('admin_panel.html', 'client-multi-ads.html');
            const clientLink = `${baseUrl}?id=${clientId}`;
            
            document.getElementById('generatedLink').value = clientLink;
            document.getElementById('linkDisplay').style.display = 'flex';
            document.getElementById('successMessage').style.display = 'block';
            
            document.getElementById('addClientForm').reset();
            document.getElementById('startTime').value = now.toISOString().slice(0, 16);
            
            updateAll();
            
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 3000);
        });
        
        function updateClientsTable() {
            const clients = getClients();
            const clientsArray = Object.values(clients);
            const accounts = getAccounts();
            const tbody = document.getElementById('clientsTableBody');
            const now = Date.now();
            
            document.getElementById('clientCount').textContent = clientsArray.length;
            
            if (clientsArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 30px; color: #999;">No hay clientes registrados</td></tr>`;
                return;
            }
            
            tbody.innerHTML = clientsArray.map(client => {
                const endTime = client.startTime + (client.duration * 60 * 1000);
                const isExpired = now >= endTime;
                const isActive = client.active && !isExpired;
                
                let status, statusClass;
                if (isExpired) {
                    status = 'Expirado';
                    statusClass = 'status-expired';
                } else if (isActive) {
                    status = 'Activo';
                    statusClass = 'status-active';
                } else {
                    status = 'Pausado';
                    statusClass = 'status-blocked';
                }
                
                const remaining = Math.max(0, endTime - now);
                const days = Math.floor(remaining / (24 * 60 * 60 * 1000));
                const hours = Math.floor((remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                const remainingStr = isExpired ? 'Expirado' : `${days}d ${hours}h`;
                
                const endDateStr = new Date(endTime).toLocaleDateString('es-ES', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                const account = accounts[client.accountId];
                const accountName = account ? account.name : 'Sin cuenta';
                
                return `
                    <tr>
                        <td>
                            <strong>${client.name}</strong>
                            ${client.phone ? `<br><small style="color:#999">${client.phone}</small>` : ''}
                        </td>
                        <td>${accountName}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>
                            <strong style="color:#00ff88">$${client.totalPaid.toFixed(2)}</strong>
                            <br><small style="color:#999">${client.payments.length} pago(s)</small>
                        </td>
                        <td>${remainingStr}</td>
                        <td>${endDateStr}</td>
                        <td>
                            <button onclick="openRenewModal('${client.id}')" class="btn-success btn-small" title="Renovar">üîÑ</button>
                            <button onclick="copyClientLink('${client.id}')" class="btn-info btn-small" title="Copiar link">üìã</button>
                            <button onclick="toggleClient('${client.id}')" class="btn-warning btn-small" title="${isActive ? 'Pausar' : 'Activar'}">
                                ${isActive ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                            </button>
                            <button onclick="releaseAccount('${client.id}')" class="btn-primary btn-small" title="Liberar cuenta">üîì</button>
                            <button onclick="deleteClient('${client.id}')" class="btn-danger btn-small" title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function openRenewModal(clientId) {
            const clients = getClients();
            const client = clients[clientId];
            if (!client) return;
            
            document.getElementById('renewClientId').value = clientId;
            document.getElementById('renewClientName').value = client.name;
            document.getElementById('renewDays').value = 7;
            document.getElementById('renewAmount').value = '';
            document.getElementById('renewModal').classList.add('active');
        }
        
        function closeRenewModal() {
            document.getElementById('renewModal').classList.remove('active');
        }
        
        document.getElementById('renewForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const clientId = document.getElementById('renewClientId').value;
            const days = parseInt(document.getElementById('renewDays').value);
            const amount = parseFloat(document.getElementById('renewAmount').value) || 0;
            
            const clients = getClients();
            if (clients[clientId]) {
                // Agregar tiempo
                clients[clientId].duration += days * 24 * 60;
                
                // Registrar pago
                clients[clientId].payments.push({
                    date: Date.now(),
                    amount: amount,
                    type: 'renewal',
                    note: `Renovaci√≥n ${days} d√≠as`
                });
                clients[clientId].totalPaid += amount;
                
                saveClients(clients);
                
                // Registrar ingreso
                addMovement('income', `Renovaci√≥n: ${clients[clientId].name} (+${days} d√≠as)`, amount);
                
                closeRenewModal();
                updateAll();
                alert('‚úÖ Cliente renovado exitosamente!');
            }
        });
        
        function releaseAccount(clientId) {
            if (!confirm('üîì ¬øLiberar la cuenta de este cliente?\n\nLa cuenta quedar√° disponible para asignar a otro cliente.')) return;
            
            const clients = getClients();
            const client = clients[clientId];
            if (!client) return;
            
            // Liberar cuenta
            const accounts = getAccounts();
            if (accounts[client.accountId]) {
                accounts[client.accountId].status = 'available';
                accounts[client.accountId].currentClient = null;
                saveAccounts(accounts);
            }
            
            // Eliminar cliente o marcarlo como finalizado
            client.active = false;
            client.accountId = null;
            saveClients(clients);
            
            updateAll();
        }
        
        function toggleClient(clientId) {
            const clients = getClients();
            if (clients[clientId]) {
                clients[clientId].active = !clients[clientId].active;
                saveClients(clients);
                updateAll();
            }
        }
        
        function copyClientLink(clientId) {
            const baseUrl = window.location.href.replace('admin_panel.html', 'client-multi-ads.html');
            const clientLink = `${baseUrl}?id=${clientId}`;
            navigator.clipboard.writeText(clientLink);
            alert('‚úÖ Link copiado!');
        }
        
        function deleteClient(clientId) {
            if (!confirm('¬øEliminar este cliente permanentemente?')) return;
            
            const clients = getClients();
            const client = clients[clientId];
            
            // Liberar cuenta
            if (client && client.accountId) {
                const accounts = getAccounts();
                if (accounts[client.accountId]) {
                    accounts[client.accountId].status = 'available';
                    accounts[client.accountId].currentClient = null;
                    saveAccounts(accounts);
                }
            }
            
            delete clients[clientId];
            saveClients(clients);
            updateAll();
        }
        
        function copyLink() {
            const linkInput = document.getElementById('generatedLink');
            linkInput.select();
            document.execCommand('copy');
            alert('‚úÖ Link copiado!');
        }
        
        function openLink() {
            const link = document.getElementById('generatedLink').value;
            window.open(link, '_blank');
        }
        
        function filterClients() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#clientsTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // ==================== MOVIMIENTOS FINANCIEROS ====================
        function getMovements() {
            return JSON.parse(localStorage.getItem('mp_movements') || '[]');
        }
        
        function saveMovements(movements) {
            localStorage.setItem('mp_movements', JSON.stringify(movements));
        }
        
        function addMovement(type, description, amount) {
            const movements = getMovements();
            movements.unshift({
                id: 'mov_' + Date.now(),
                date: Date.now(),
                type: type, // income, expense, loss, recovery
                description: description,
                amount: amount
            });
            saveMovements(movements);
        }
        
        function updateMovementsTable() {
            const movements = getMovements();
            const tbody = document.getElementById('movementsTableBody');
            
            if (movements.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">No hay movimientos registrados</td></tr>`;
                return;
            }
            
            tbody.innerHTML = movements.slice(0, 50).map(mov => {
                let typeText, typeColor;
                switch(mov.type) {
                    case 'income':
                        typeText = 'üí∞ Ingreso';
                        typeColor = '#00ff88';
                        break;
                    case 'expense':
                        typeText = 'üí∏ Gasto';
                        typeColor = '#ffa500';
                        break;
                    case 'loss':
                        typeText = 'üö´ P√©rdida';
                        typeColor = '#ff6b6b';
                        break;
                    case 'recovery':
                        typeText = '‚úÖ Recuperado';
                        typeColor = '#00d4ff';
                        break;
                }
                
                const dateStr = new Date(mov.date).toLocaleString('es-ES');
                const amountStr = mov.type === 'income' || mov.type === 'recovery' 
                    ? `+$${mov.amount.toFixed(2)}` 
                    : `-$${mov.amount.toFixed(2)}`;
                
                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td style="color:${typeColor}">${typeText}</td>
                        <td>${mov.description}</td>
                        <td style="color:${typeColor}; font-weight: bold;">${amountStr}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // ==================== RESUMEN FINANCIERO ====================
        function updateFinanceSummary() {
            const movements = getMovements();
            
            let totalIncome = 0;
            let totalExpense = 0;
            
            movements.forEach(mov => {
                if (mov.type === 'income') {
                    totalIncome += mov.amount;
                } else if (mov.type === 'expense' || mov.type === 'loss') {
                    totalExpense += mov.amount;
                } else if (mov.type === 'recovery') {
                    totalExpense -= mov.amount; // Recuperar reduce los gastos
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            document.getElementById('totalIncome').textContent = '$' + totalIncome.toFixed(2);
            document.getElementById('totalExpense').textContent = '$' + totalExpense.toFixed(2);
            document.getElementById('totalBalance').textContent = (balance >= 0 ? '+' : '') + '$' + balance.toFixed(2);
            
            // Color del balance
            const balanceEl = document.getElementById('totalBalance');
            if (balance > 0) {
                balanceEl.className = 'finance-value positive';
            } else if (balance < 0) {
                balanceEl.className = 'finance-value negative';
            } else {
                balanceEl.className = 'finance-value neutral';
            }
        }
        
        // ==================== ACTUALIZAR TODO ====================
        function updateAll() {
            updateAccountsTable();
            updateClientsTable();
            updateMovementsTable();
            updateFinanceSummary();
        }
        
        // Inicializar
        updateAll();
        setInterval(updateAll, 5000);
    </script>
</body>
</html>
